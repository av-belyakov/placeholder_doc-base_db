# Placeholder_doc_base_db

[![Go Version](https://img.shields.io/badge/Go-1.24.4+-00ADD8?style=flat&logo=go)](https://golang.org/)
[![Docker](https://img.shields.io/badge/Docker-Ready-2496ED?style=flat&logo=docker)](https://www.docker.com/)

Сервис 'placeholder_doc_base_db' принимает любые, структурированные в формате JSON, данные, разбирает их и укладывает в документо-ориентированную базу данных.

## Конфигурационные настройки

Конфигурационные параметры для сервиса, могут быть заданы как через конфигурационный файл, так и методом установки переменных окружения. Однако, все пароли и ключевые токены, используемые для авторизации, задаются ТОЛЬКО через переменные окружения.

#### Типы конфигурационных файлов:

- config.yml общий конфигурационный файл, здесь хранятся настройки логирования, параметры доступа к Zabbix и параметры для настройки профилирования через pprof;
- config_test.yml конфигурационный файл используемый для тестов при разработке;
- config_dev.yml конфигурационный файл используемый при развертывании тестовой инфраструктуры максимально приближенной к продуктовой;
- config_prod.yml конфигурационный файл применяемый в продуктовом режиме.

Внимание!!!
Ключи в настройках конфигурационных файлов и соответствующих им переменных окружения должны буть одинаковы. Речь идет об ключах в настройках NATS.subscriptions и DATABASESTORAG.storage_name_db.

Основная переменная окружения для данного приложения - GO_PHDOCBASEDB_MAIN. На основании значения этой переменной принимается решение какой из конфигурационных файлов config_test.yml, config_dev.yml или config_prod.yml использовать. При GO_PHDOCBASEDB_MAIN=development будет использоваться config_dev.yml, при GO_PHDOCBASEDB_MAIN=test будет использоваться config_test.yml, во всех остальных случаях, в том числе и при отсутствии переменной окружения GO_PHDOCBASEDB_MAIN будет использоваться конфигурационный файл config_prod.yml. Перечень переменных окружения которые можно использовать для настройки приложения:

Профилирование доступно только для режимов test и development.

#### Переменная окружения отвечающая за тип запуска приложения "test", "development" или "production"

- GO_PHDOCBASEDB_MAIN

Например:

```bash
export GO_PHDOCBASEDB_MAIN=test
```

#### Переменные окружения отвечающие за подключение к NATS

- GO_PHDOCBASEDB_NHOST - ip или доменное имя;
- GO_PHDOCBASEDB_NPORT - сетевой порт;
- GO_PHDOCBASEDB_NCACHETTL - данный параметр должен содержать время жизни записи
  кэша, по истечение которого запись автоматически удаляется, значение задается
  в секундах в диапазоне от 10 до 86400 секунд;
- GO_PHDOCBASEDB_NCOMMAND - публикация команд, которые нужно выполнить в TheHive;
- GO_PHDOCBASEDB_NSUBLISTENER - подписки для приёма информации (например, такой как alert или case). Для этой переменной можно задавать список параметров типа ключ:значение, параметры между собой разделяются специальным символом ';'.
  Например, alert:subscriber.alert;case:subscriber.case.
- GO_PHDOCBASEDB_REQUESTS - запросы дополнительной информации по геопозиционировании ip адресов и информации о месте расположения и принадлежноти сенсоров. Для этой переменной можно задавать список параметров типа ключ:значение, параметры между собой разделяются специальным символом ';'.
  Например, get_geoip_info:object.geoip-request;get_sensor_info:object.sensor-info-request.

#### Переменные окружения отвечающие за настройку доступа к БД применяемой для хранения TheHive объектов типа 'alert' и 'case'

- GO_PHDOCBASEDB_DBSTORAGEHOST - доменное имя или ip БД;
- GO_PHDOCBASEDB_DBSTORAGEPORT - порт БД;
- GO_PHDOCBASEDB_DBSTORAGENAME - наименование БД (при необходимости);
- GO_PHDOCBASEDB_DBSTORAGEUSER - пользователь БД;
- GO_PHDOCBASEDB_DBSTORAGEPASSWD - пароль для доступа к БД;
- GO_PHDOCBASEDB_DBSTORAGEN - список таблиц БД где хранятся объекты разного типа (например alert и case). Для этой переменной можно задавать список параметров типа ключ:значение, параметры между собой разделяются специальным символом ';'.
  Например, alert:test.module_placeholderdb_alert;case:test.module_placeholderdb_case.

#### Переменные окружения отвечающие за настройку доступа к БД применяемой для хранения логов

- GO_PHDOCBASEDB_DBWLOGHOST - доменное имя или ip БД
- GO_PHDOCBASEDB_DBWLOGPORT - порт БД
- GO_PHDOCBASEDB_DBWLOGNAME - наименование БД (при необходимости)
- GO_PHDOCBASEDB_DBWLOGUSER - пользователь БД
- GO_PHDOCBASEDB_DBWLOGPASSWD - пароль для доступа к БД
- GO_PHDOCBASEDB_DBWLOGSTORAGENAME - наименование объекта хранения логов (таблица, документ, индекс и т.д. зависит от типа БД)

Настройки логирования данных в БД не являются обязательными и необходимы только если пользователь приложения желает хранить логи в базе данных.

Приоритет значений заданных через переменные окружения выше чем значений полученных из конфигурационных файлов. Таким образом можно осуществлять гибкую временную настройку приложения.

## Профилирование приложения

Профилирование приложения возможно только в двух режимах "test" или "development". Для того что бы получить доступ к профилировщику нужно выполнить в браузере или GET запросы с помощью wget или curl следующее:

```bash
http://<ip>:<port>//debug/pprof/
```

Использование инструмента 'go tool pprof'.

```bash
go tool pprof http://<ip>:<port>/debug/pprof/... (далее возможны вариации heap, allocs, goroutine и т.д.)
```

- **goroutine** — следы всех текущих горутин;
- **heap** — выборка выделений памяти живых объектов;
- **allocs** — выборка всех прошлых выделений памяти;
- **threadcreate** — следы стека, которые привели к созданию новых потоков в операционной системе;
- **block** — следы стека, которые привели к блокировке примитивов синхронизации;
- **mutex** — следы стека держателей конфликтующих мьютексов.

## Передача команд обратно в TheHive

После успешной отправки в MISP сформированных сообщений в TheHive отправляется два JSON сообщения. Сообщение с командой на установку тега в обработанном кейсе TheHive:

```json
{
  "service": "placeholder_doc-base_db",
  "command": "add_case_tag",
  "for_regional_object": "gcm",
  "root_id": "%s",
  "case_id": "%s",
  "value": "Webhook: send=\"ElasticsearchDB\""
}
```
